import Foundation

/// Deletes the Core ML delegateâ€™s compiled-model cache that TensorFlow Lite
/// leaves in Library/Caches/org.tensorflow.lite.coreml.
enum CoreMLCacheCleaner {

    /// Call once at launch. Runs on a background queue so it never blocks UI.
    static func clean() {
        DispatchQueue.global(qos: .utility).async {
            let fm = FileManager.default

            guard let cachesURL = fm.urls(for: .cachesDirectory,
                                          in: .userDomainMask).first else { return }

            let coreMLCacheURL = cachesURL.appendingPathComponent("org.tensorflow.lite.coreml",
                                                                  isDirectory: true)

            guard
                fm.fileExists(atPath: coreMLCacheURL.path),
                let contents = try? fm.contentsOfDirectory(at: coreMLCacheURL,
                                                           includingPropertiesForKeys: nil)
            else { return }

            for url in contents {
                try? fm.removeItem(at: url)        // swallow errors; safest for production
            }
        }
    }
}
