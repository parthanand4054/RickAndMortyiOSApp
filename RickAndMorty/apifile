// MARK: - runs embedding matching every Nth frame
func runMatchingOnBoundingBoxes(for frame: CGImage) {
    guard let boxes = self.boundingBoxes, !boxes.isEmpty else { return }

    var updated = boxes
    let group   = DispatchGroup()
    let lock    = DispatchQueue(label: "org.walmart.boundingBoxLock")

    for index in boxes.indices {
        group.enter()
        Task.detached {                                 //  ‚Üê async context
            let upc = boxes[index].id.description       // your UPC derivation here
            await self.inferenceVM.embeddingMatcher?.ensureEmbeddings(for: upc)

            let matchID = self.inferenceVM.match(detection: boxes[index], from: frame)

            if let matchID {
                lock.sync { updated[index].prodID = matchID }
            }
            group.leave()
        }
    }

    group.notify(queue: .main) {
        self.boundingBoxes = updated
    }
}
